---
title: 深入了解条件
categories: [guide]
order: 30
meta:
  keywords: ~
  description: ~
---

感谢 [ucast](https://github.com/stalniy/ucast)，我们可以使用 [MongoDB 查询语言](http://docs.mongodb.org/manual/reference/operator/query/) 来定义权限。

如果你不熟悉 MongoDB 查询语言，不用担心。我们将在本指南中介绍其中的一些操作符。但在开始之前，让我们通过创建一个简单的文章调度逻辑来看看它有多有用，该逻辑只允许读取 `createdAt` 在过去的文章：

```js
import { defineAbility } from '@casl/ability';

const today = new Date().setHours(0, 0, 0, 0);

export default defineAbility((can) => {
  can('read', 'Article', { createdAt: { $lte: today } })
});
```

或者让我们允许读取状态为 `review` 或 `published` 的文章：

```js
import { defineAbility } from '@casl/ability';

export default defineAbility((can) => {
  can('read', 'Article', { status: { $in: ['review', 'published'] } })
});
```

你看到它带来的强大功能了吗？

## MongoDB 及其查询语言

[MongoDB](https://www.mongodb.com/) 是一个通用的、基于文档的分布式数据库，专为现代应用程序和云时代而构建。简单来说，这是一个 [NoSQL](https://en.wikipedia.org/wiki/NoSQL) 数据库，以 `JSON` 格式（实际上是 [BSON](https://docs.mongodb.com/manual/reference/glossary/#term-bson)）存储记录。

由于他们决定以 `JSON` 格式存储记录，他们需要一种新的查询语言来从数据库中获取过滤后的记录。这就是他们创建自己查询语言的原因。

JavaScript 是 `JSON` 的超集，这就是为什么我们决定使用 MongoDB 查询语言来基于主体的属性限制权限。

**你不需要了解任何关于 MongoDB 的知识**来使用 CASL，你只需要了解其查询语言操作符的子集。

查询是你在 `can` 和 `cannot` 函数的条件中传递的内容（如果传递字段，则是第3个或第4个参数）。因此，它是一个对象，定义了对 JavaScript 对象的限制，如果这些限制匹配，则返回匹配的对象。

让我们看看查询的示例：

```js
const queries = [
  { private: true }, // (1)
  { private: false, hidden: false }, // (2)
  { private: { $exists: true } },
  { status: { $in: ['review', 'inProgress'] } },
  { price: { $gte: 10, $lte: 50 } }, // (3)
  { tags: { $all: ['permission', 'casl'] } },
  { email: { $regex: /@gmail.com$/i } },
  { 'cities.address': { $elemMatch: { postalCode: { $regex: /^AB/ } } } } // (4)
]
```

我们可以在单个查询中组合任意数量的字段，所有限制都按照 `AND` 逻辑进行测试。如果我们不指定操作符，查询使用 `$eq` 操作符（相等操作符）。因此，像 `(2)` 这样的查询匹配 `private` 和 `hidden` 属性值都等于 `false` 的对象（即 `!object.private && !object.hidden`）。

我们可以为同一字段指定多个操作符，在这种情况下，每个操作符都必须返回 `true` 才能匹配字段值。因此，`(3)` 只匹配 `price` 属性值在 10 到 50 之间（包含边界）的对象（即 `object.price >= 10 && object.price <= 50`）。

要访问嵌套属性值，你可以使用点表示法，如 `(4)` 所示。

## 支持的操作符

CASL 只使用 MongoDB 操作符的子集，这些操作符涵盖了大多数情况。

> 如果你需要使用更多操作符或定义自定义操作符，请阅读 [自定义能力](../../advanced/customize-ability)

操作符列表：

1. [$eq] 和 [$ne]\
   对象值应该等于指定值。`$ne` 表示 `not $eq`
2. [$lt] 和 [$lte]\
   对象值应该小于指定值。可用于 `Date`、数字和字符串。`$lte` 是 `$lt` 和 `$eq` 的组合，因此是包含性检查。
3. [$gt] 和 [$gte]\
   对象值应该大于指定值。可用于 `Date`、数字和字符串。`$gte` 是 `$gt` 和 `$eq` 的组合，因此是包含性检查。
4. [$in] 和 [$nin]\
   检查对象的属性是否为指定数组值之一。可用于单个值和数组。如果对象的属性是数组，它检查交集。`$nin` 表示 `not $in`
5. [$all]\
   检查对象的属性应该包含指定数组中的所有元素。只能用于数组。
6. [$size]\
   检查数组长度是否等于指定值。只能用于数组
7. [$regex]\
   允许使用 [正则表达式](https://en.wikipedia.org/wiki/Regular_expression) 测试对象的属性值。只能用于字符串
8. [$exists]\
   检查属性是否存在于对象中。
9. [$elemMatch]\
   检查嵌套元素的形状。使用 `$elemMatch` 操作符为数组元素指定多个条件，使至少一个数组元素满足所有指定条件。如果你在 `$elemMatch` 表达式中只指定一个条件，则不需要 `$elemMatch`。详情请参见 [为数组元素指定多个条件](https://docs.mongodb.com/manual/tutorial/query-arrays/#specify-multiple-criteria-for-array-elements)。

[$eq]: https://docs.mongodb.com/manual/reference/operator/query/eq
[$ne]: https://docs.mongodb.com/manual/reference/operator/query/ne
[$lt]: https://docs.mongodb.com/manual/reference/operator/query/lt
[$lte]: https://docs.mongodb.com/manual/reference/operator/query/lte
[$gt]: https://docs.mongodb.com/manual/reference/operator/query/gt
[$gte]: https://docs.mongodb.com/manual/reference/operator/query/gte
[$in]: https://docs.mongodb.com/manual/reference/operator/query/in
[$nin]: https://docs.mongodb.com/manual/reference/operator/query/nin
[$all]: https://docs.mongodb.com/manual/reference/operator/query/all
[$size]: https://docs.mongodb.com/manual/reference/operator/query/size
[$regex]: https://docs.mongodb.com/manual/reference/operator/query/regex
[$elemMatch]: https://docs.mongodb.com/manual/reference/operator/query/elemMatch
[$exists]: https://docs.mongodb.com/manual/reference/operator/query/exists

## 为什么不包含逻辑查询操作符

CASL 不使用 `$and`、`$or`、`$nor` 和 `$not` 操作符。这是因为通过组合 `can` 和 `cannot` 规则可以实现相同的行为。对于相同的动作和主体对，组合 `can` 规则可以模拟 `$or` 操作符，组合 `cannot` 规则可以模拟 `$not` 和 `$and` 操作符。此外，正如我们在本指南中讨论的，条件对象内的所有属性都按 `AND` 逻辑检查，这是模拟 `$and` 操作符的另一种方式。

`$nor` 无法以任何方式重现，所以如果你确定需要它，我建议与客户或产品负责人一起重新思考你的权限逻辑。但如果你 100% 确定，请阅读如何 [自定义能力](../../advanced/customize-ability)。

## CASL 中的检查逻辑

当你定义带有条件的规则时，这些条件会被转换为检查对象是否匹配指定 MongoDB 查询的函数。让我们看一个例子：

```js @{data-filename="defineAbility.js"}
import { defaultAbility } from '@casl/ability';

export default defaultAbility((can) => {
  can('read', 'Article', {
    createdAt: { $lte: new Date() },
    status: { $in: ['review', 'published'] }
  })
});
```

上面的例子说明，如果文章处于审核或已发布状态，并且其创建日期在过去或今天，则可以读取该文章。在开始之前，让我们定义一个表示 `Article` 实体的简单类。

```js @{data-filename="entities.js"}
export class Article {
  constructor(status, createdAt) {
    this.status = status;
    this.createdAt = createdAt;
  }
}
```

> 使用类不是强制性的，CASL 完全适用于普通的 JavaScript 对象，详情请参见 [主体类型检测](../guide/subject-type-detection  )。

现在我们可以测试用户可以读取哪些文章：

```js
import ability from './defineAbility';
import { Article } from './entities';

const today = new Date().setHours(0, 0, 0, 0);
const tomorrow = /* logic to calculate date for tomorrow */ ;

ability.can('read', new Article('review', today)) // (1), true
ability.can('read', new Article('published', today)) // (2), true
ability.can('read', new Article('draft', today)) // (3), false
ability.can('read', new Article('review', tomorrow)) // (4), false
```

`(1)` 和 `(2)` 返回 `true`，因为文章的状态是指定的状态之一，并且 `today` 小于条件中指定的值。
`(3)` 失败，因为文章的状态未列在 `$in` 操作符中，`(4)` 失败，因为文章的 `createdAt` 在未来。

相同的逻辑适用于条件中的其他操作符。

## 常见条件

本节描述了构建常见情况条件的方法。

### 匹配标量属性中的几个项目之一

假设我们有一个具有 `status` 属性的 `Article` 对象。我们想要限制用户只能访问处于几个特定状态的文章。

```js
import { defineAbility } from '@casl/ability';

const ability = defineAbility((can) => {
  can('read', 'Article', { status: { $in: ['published', 'inReview'] } });
});

class Article {
  constructor(title, status) {
    this.title = title;
    this.status = status;
  }
}

const article = new Article('CASL', 'published');
console.log(ability.can('read', article)); // true
```

### 匹配数组属性中的指定项目

假设我们有一个具有 `categories` 属性的 `Article` 对象。我们想要限制用户只能访问一个指定类别的文章。

```js
import { defineAbility } from '@casl/ability';

const ability = defineAbility((can) => {
  can('read', 'Article', { categories: 'javascript' });
});

class Article {
  constructor(title, categories) {
    this.title = title;
    this.categories = categories;
  }
}

const article = new Article('CASL', ['javascript', 'acl']);
console.log(ability.can('read', article)); // true
```

### 匹配数组属性中的几个项目之一

假设我们有一个具有 `categories` 属性的 `Article` 对象。我们想要限制用户只能访问几个指定类别的文章。

```js
import { defineAbility } from '@casl/ability';

const ability = defineAbility((can) => {
  can('read', 'Article', { categories: { $in: ['javascript', 'frontend'] } });
});

class Article {
  constructor(title, categories) {
    this.title = title;
    this.categories = categories;
  }
}

const article = new Article('CASL', ['javascript', 'acl']);
console.log(ability.can('read', article)); // true
```

### 匹配嵌套属性值

假设我们有一个 `Address` 对象，它有一个 `country` 属性，该属性是一个包含两个字段的对象：`isoCode` 和 `name`。我们想要限制用户只能访问位于指定国家的地址。

```js
import { defineAbility } from '@casl/ability';

const ability = defineAbility((can) => {
  can('read', 'Address', { 'country.isoCode': 'UA' });
});

class Address {
  constructor(isoCode, name) {
    this.country = {
      isoCode: isoCode,
      name: name,
    }
  }
}

const address = new Address('UA', 'Ukraine');
console.log(ability.can('read', address)); // true
```

### 匹配嵌套数组属性的多个属性

假设我们在某个电商网站有一个产品愿望清单，我们想要与其他人分享愿望清单项目并给他 `update` 权限。

```js
import { defineAbility } from '@casl/ability';

const user = { id: 1 };
const ability = defineAbility((can) => {
  can('update', 'WishlistItem', {
    sharedWith: {
      $elemMatch: { permission: 'update', userId: user.id }
    }
  });
});

class WishlistItem {
  constructor(title, sharedWith) {
    this.title = title;
    this.sharedWith = sharedWith;
  }
}

const wishlistItem = new WishlistItem('CASL in Action', [
  { permission: 'read', userId: 2 },
  { permission: 'update', userId: 1 },
]);
ability.can('update', wishlistItem); // true
```
